name: Master Dataset Ingestion Pipeline

on:
  schedule:
    # Run daily at 01:00 UTC to coordinate all ingestion workflows
    - cron: '0 1 * * *'
  workflow_dispatch:
    inputs:
      force_all:
        description: 'Force run all ingestion workflows'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  check-schedule:
    runs-on: ubuntu-latest
    outputs:
      run_kaggle: ${{ steps.schedule.outputs.run_kaggle }}
      run_github: ${{ steps.schedule.outputs.run_github }}
      run_ml: ${{ steps.schedule.outputs.run_ml }}
      run_quantum: ${{ steps.schedule.outputs.run_quantum }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Determine what to run
        id: schedule
        run: |
          # Check if it's the 1st of the month (Kaggle - monthly)
          if [ $(date +%d) -eq 01 ] || [ "${{ inputs.force_all }}" == "true" ]; then
            echo "run_kaggle=true" >> $GITHUB_OUTPUT
          else
            echo "run_kaggle=false" >> $GITHUB_OUTPUT
          fi
          
          # Check if it's Sunday (GitHub - weekly)
          if [ $(date +%u) -eq 7 ] || [ "${{ inputs.force_all }}" == "true" ]; then
            echo "run_github=true" >> $GITHUB_OUTPUT
          else
            echo "run_github=false" >> $GITHUB_OUTPUT
          fi
          
          # Check if it's Monday (ML - weekly)
          if [ $(date +%u) -eq 1 ] || [ "${{ inputs.force_all }}" == "true" ]; then
            echo "run_ml=true" >> $GITHUB_OUTPUT
          else
            echo "run_ml=false" >> $GITHUB_OUTPUT
          fi
          
          # Check if it's the 15th (Quantum - monthly)
          if [ $(date +%d) -eq 15 ] || [ "${{ inputs.force_all }}" == "true" ]; then
            echo "run_quantum=true" >> $GITHUB_OUTPUT
          else
            echo "run_quantum=false" >> $GITHUB_OUTPUT
          fi

  validate-schemas:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install jsonschema

      - name: Validate JSON Schemas
        run: |
          python -c "
          import json
          import os
          from pathlib import Path
          
          schema_dir = Path('datasets/schemas')
          if schema_dir.exists():
              for schema_file in schema_dir.glob('*.json'):
                  try:
                      with open(schema_file) as f:
                          schema = json.load(f)
                      print(f'✓ Valid schema: {schema_file.name}')
                  except Exception as e:
                      print(f'✗ Invalid schema {schema_file.name}: {e}')
                      exit(1)
          print('All schemas validated successfully')
          "

  update-manifest:
    runs-on: ubuntu-latest
    needs: [check-schedule, validate-schemas]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Update Build Manifest
        run: |
          CURRENT_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          cat > build_manifest_update.yaml << EOF
          
          # Permutation Enhancement Module
          permutation_capabilities:
            ingestion_status: active
            last_pipeline_run: ${CURRENT_DATE}
            active_sources:
              kaggle: ${{ needs.check-schedule.outputs.run_kaggle }}
              github: ${{ needs.check-schedule.outputs.run_github }}
              ml_training: ${{ needs.check-schedule.outputs.run_ml }}
              quantum: ${{ needs.check-schedule.outputs.run_quantum }}
            
          datasets_ingested:
            mathematical: active
            programming_libraries: active
            ml_training: active
            quantum: active
            
          schemas:
            - recursive_annotation
            - combinatorial_algebra
            - dataset_metadata
          EOF
          
          # Append to existing manifest
          cat build_manifest_update.yaml >> build_manifest.yaml
          rm build_manifest_update.yaml

      - name: Commit Manifest Update
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add build_manifest.yaml
          git commit -m "Update build manifest with ingestion pipeline status" || echo "No changes to commit"
          git push

  generate-ingestion-report:
    runs-on: ubuntu-latest
    needs: [check-schedule, validate-schemas]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate Ingestion Report
        run: |
          mkdir -p datasets/reports
          
          cat > datasets/reports/ingestion_status.md << 'EOF'
          # Dataset Ingestion Status Report
          
          **Generated:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          ## Active Data Sources
          
          ### Mathematical & Logical Data
          - **Status:** Active
          - **Source:** Kaggle, Public APIs
          - **Schedule:** Monthly (1st of month)
          - **Next Run:** ${{ needs.check-schedule.outputs.run_kaggle == 'true' && 'Today' || 'Scheduled' }}
          
          ### Programming Libraries
          - **Status:** Active
          - **Source:** GitHub
          - **Schedule:** Weekly (Sundays)
          - **Next Run:** ${{ needs.check-schedule.outputs.run_github == 'true' && 'Today' || 'Scheduled' }}
          
          ### ML Training Data
          - **Status:** Active
          - **Source:** Synthetic Generation, Benchmarks
          - **Schedule:** Weekly (Mondays)
          - **Next Run:** ${{ needs.check-schedule.outputs.run_ml == 'true' && 'Today' || 'Scheduled' }}
          
          ### Quantum Computing Libraries
          - **Status:** Active
          - **Source:** GitHub (Quantum repositories)
          - **Schedule:** Monthly (15th of month)
          - **Next Run:** ${{ needs.check-schedule.outputs.run_quantum == 'true' && 'Today' || 'Scheduled' }}
          
          ## Schema Status
          
          - ✓ Recursive Annotation Schema
          - ✓ Combinatorial Algebra Schema
          - ✓ Dataset Metadata Schema
          
          ## Pipeline Configuration
          
          - **Validation:** Enabled
          - **Auto-annotation:** Enabled
          - **Backup:** Enabled
          - **Quality Checks:** Active
          
          EOF
          
          echo "Report generated at datasets/reports/ingestion_status.md"

      - name: Commit Report
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add datasets/reports/
          git commit -m "Generate ingestion status report - $(date -u +'%Y-%m-%d')" || echo "No changes to commit"
          git push
