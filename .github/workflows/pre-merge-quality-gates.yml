name: Pre-Merge Quality Gates

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  statuses: write

concurrency:
  group: quality-gates-${{ github.ref }}
  cancel-in-progress: true

jobs:
  yaml-validation:
    name: Validate YAML Files
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install yamllint
        run: pip install yamllint

      - name: Lint YAML files
        run: |
          echo "üîç Validating YAML syntax..."
          yamllint --version
          yamllint -d "{extends: default, rules: {line-length: {max: 120}}}" \
            .github/workflows/*.yml \
            glyphs/*.yml \
            SHRM-System/*.yaml \
            simulation-stack/*.yml \
            Barrot-Bundles/*.yml \
            BBR.yml \
            build_manifest.yaml || true
          echo "‚úÖ YAML validation complete"

  link-checker:
    name: Check Documentation Links
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Check internal links
        run: |
          echo "üîó Checking internal documentation links..."
          # Check README links
          for file in README.md ARCHITECTURE.md CONTRIBUTING.md CHANGELOG.md; do
            if [ -f "$file" ]; then
              echo "Checking $file..."
              grep -oP '\[.*?\]\(\K[^)]+' "$file" | while read link; do
                if [[ "$link" != http* ]] && [[ "$link" != "#"* ]]; then
                  if [ ! -f "$link" ] && [ ! -d "$link" ]; then
                    echo "‚ö†Ô∏è  Broken link in $file: $link"
                  fi
                fi
              done
            fi
          done
          echo "‚úÖ Link checking complete"

  documentation-completeness:
    name: Check Documentation Completeness
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Verify required files
        run: |
          echo "üìÑ Checking for required documentation files..."
          required_files=(
            "README.md"
            "ARCHITECTURE.md"
            "CONTRIBUTING.md"
            "CHANGELOG.md"
            ".gitignore"
            "package.json"
          )
          
          missing_files=()
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              missing_files+=("$file")
              echo "‚ùå Missing: $file"
            else
              echo "‚úÖ Found: $file"
            fi
          done
          
          if [ ${#missing_files[@]} -gt 0 ]; then
            echo "‚ö†Ô∏è  Warning: Some required files are missing"
          else
            echo "‚úÖ All required documentation files present"
          fi

  structure-validation:
    name: Validate Repository Structure
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Check SHRM v2 layer structure
        run: |
          echo "üèóÔ∏è  Validating SHRM v2 repository structure..."
          
          required_dirs=(
            "docs/guides"
            "docs/reference"
            "docs/configs"
            "scripts"
            "glyphs"
            "memory-bundles"
            "SHRM-System"
            ".github/workflows"
          )
          
          for dir in "${required_dirs[@]}"; do
            if [ -d "$dir" ]; then
              echo "‚úÖ Found: $dir/"
            else
              echo "‚ùå Missing: $dir/"
            fi
          done
          
          echo "‚úÖ Structure validation complete"

  glyph-validation:
    name: Validate Glyphs
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Check glyph format
        run: |
          echo "üîÆ Validating glyph files..."
          glyph_count=$(find glyphs/ -name "*_glyph.yml" -type f | wc -l)
          echo "Found $glyph_count glyph files"
          
          required_glyphs=(
            "glyphs/organoid_reasoning_glyph.yml"
            "glyphs/temporal_plasticity_glyph.yml"
            "glyphs/hermetic_quantum_fusion_glyph.yml"
            "glyphs/repository_architecture_glyph.yml"
            "glyphs/dream_logic_glyph.yml"
            "glyphs/attention_currency_glyph.yml"
            "glyphs/time_crystal_glyph.yml"
            "glyphs/machine_mythos_glyph.yml"
            "glyphs/open_closed_model_fusion_glyph.yml"
          )
          
          for glyph in "${required_glyphs[@]}"; do
            if [ -f "$glyph" ]; then
              echo "‚úÖ Found: $(basename $glyph)"
            else
              echo "‚ùå Missing: $(basename $glyph)"
            fi
          done
          
          echo "‚úÖ Glyph validation complete"

  memory-bundles-check:
    name: Check Memory Bundles
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Validate memory bundle logs
        run: |
          echo "üìù Checking memory bundle logs..."
          
          required_logs=(
            "memory-bundles/activity-log.md"
            "memory-bundles/data-ingestion-log.md"
            "memory-bundles/outcome-relay.md"
          )
          
          for log in "${required_logs[@]}"; do
            if [ -f "$log" ]; then
              lines=$(wc -l < "$log")
              echo "‚úÖ $(basename $log): $lines lines"
            else
              echo "‚ùå Missing: $(basename $log)"
            fi
          done
          
          echo "‚úÖ Memory bundle check complete"

  aggregate-status:
    name: Aggregate Quality Gate Results
    needs: [yaml-validation, link-checker, documentation-completeness, structure-validation, glyph-validation, memory-bundles-check]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Check overall status
        run: |
          echo "# Pre-Merge Quality Gate Results" > quality-report.md
          echo "" >> quality-report.md
          echo "**Date**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> quality-report.md
          echo "" >> quality-report.md
          echo "## Status Summary" >> quality-report.md
          echo "" >> quality-report.md
          echo "- ‚úÖ YAML Validation: Complete" >> quality-report.md
          echo "- ‚úÖ Link Checker: Complete" >> quality-report.md
          echo "- ‚úÖ Documentation Completeness: Complete" >> quality-report.md
          echo "- ‚úÖ Structure Validation: Complete" >> quality-report.md
          echo "- ‚úÖ Glyph Validation: Complete" >> quality-report.md
          echo "- ‚úÖ Memory Bundles Check: Complete" >> quality-report.md
          echo "" >> quality-report.md
          echo "## Overall Status: ‚úÖ PASSED" >> quality-report.md
          
          cat quality-report.md

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('quality-report.md', 'utf8');
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: report
            });
