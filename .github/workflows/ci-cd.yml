name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  validate:
    name: Validate Build Manifest
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Validate manifest
        run: |
          python scripts/validate_manifest.py
      
      - name: Check manifest syntax
        run: |
          python -c "import yaml; yaml.safe_load(open('build_manifest.yaml'))"

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run tests with coverage
        run: |
          python -m pytest tests/ -v --cov=. --cov-report=term --cov-report=xml
      
      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        if: always()
        with:
          file: ./coverage.xml
          fail_ci_if_error: false

  lint:
    name: Lint and Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check YAML syntax
        run: |
          for file in $(find .github/workflows -name "*.yml" -o -name "*.yaml"); do
            echo "Checking $file"
            python -c "import yaml; yaml.safe_load(open('$file'))"
          done
      
      - name: Check JSON syntax
        run: |
          for file in $(find . -name "*.json" ! -path "./node_modules/*" ! -path "./.git/*"); do
            echo "Checking $file"
            python -c "import json; json.load(open('$file'))"
          done
      
      - name: Validate HTML
        run: |
          if [ -f "site/index.html" ]; then
            echo "‚úÖ Site index.html exists"
          fi

  security:
    name: Security Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check for secrets
        run: |
          echo "üîç Scanning for potential secrets..."
          # Basic check for common secret patterns
          if grep -r -i "password\s*=\s*['\"]" . --exclude-dir=.git --exclude-dir=node_modules; then
            echo "‚ö†Ô∏è Warning: Found potential hardcoded passwords"
          fi
          if grep -r -i "api[_-]?key\s*=\s*['\"]" . --exclude-dir=.git --exclude-dir=node_modules; then
            echo "‚ö†Ô∏è Warning: Found potential hardcoded API keys"
          fi
          echo "‚úÖ Basic secret scan completed"
      
      - name: Check file permissions
        run: |
          echo "üîç Checking executable permissions..."
          find . -type f -executable ! -path "./.git/*" ! -name "*.sh" ! -name "*.py" | head -10

  build-status:
    name: Report Build Status
    runs-on: ubuntu-latest
    needs: [validate, test, lint, security]
    if: always()
    steps:
      - name: Check build status
        run: |
          echo "üìä Build Status Summary:"
          echo "  Validation: ${{ needs.validate.result }}"
          echo "  Tests: ${{ needs.test.result }}"
          echo "  Lint: ${{ needs.lint.result }}"
          echo "  Security: ${{ needs.security.result }}"
          
          if [ "${{ needs.validate.result }}" == "success" ] && \
             [ "${{ needs.test.result }}" == "success" ] && \
             [ "${{ needs.lint.result }}" == "success" ] && \
             [ "${{ needs.security.result }}" == "success" ]; then
            echo "‚úÖ All checks passed!"
            exit 0
          else
            echo "‚ùå Some checks failed"
            exit 1
          fi
